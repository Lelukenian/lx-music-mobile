name: Build for TrollStore

on:
  push:
    branches: [ "master", "main" ]
  workflow_dispatch: # å…è®¸ä½ æ‰‹åŠ¨ç‚¹å‡»æŒ‰é’®è§¦å‘

jobs:
  build-no-sign:
    runs-on: macos-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install JS Dependencies
        run: |
          # ä½¿ç”¨ legacy-peer-deps é˜²æ­¢å› ç‰ˆæœ¬å†²çªå¯¼è‡´çš„å®‰è£…å¤±è´¥
          npm install --legacy-peer-deps

      - name: Install Pods
        run: |
          cd ios
          # å®‰è£…åŸç”Ÿä¾èµ–
          pod install --repo-update

      - name: ğŸ” Detect Project Name & Build
        run: |
          cd ios
          echo "--------------------------------------"
          echo "æ­£åœ¨æ‰«æ ios æ–‡ä»¶å¤¹ä¸‹çš„æ–‡ä»¶..."
          ls -al
          echo "--------------------------------------"

          # 1. è‡ªåŠ¨å¯»æ‰¾ .xcworkspace æ–‡ä»¶
          # è§£é‡Šï¼šæ‰¾åˆ°ç¬¬ä¸€ä¸ªåç¼€ä¸º .xcworkspace çš„æ–‡ä»¶
          WORKSPACE_FILE=$(find . -maxdepth 1 -name "*.xcworkspace" | head -n 1)
          
          if [ -z "$WORKSPACE_FILE" ]; then
            echo "âŒ ä¸¥é‡é”™è¯¯: æ‰¾ä¸åˆ° .xcworkspace æ–‡ä»¶ï¼æ— æ³•ç¼–è¯‘ï¼"
            exit 1
          fi

          # 2. æå–æ–‡ä»¶åä½œä¸º Scheme åç§°
          # è§£é‡Šï¼šå»æ‰åç¼€ï¼Œåªä¿ç•™åå­—ã€‚ä¾‹å¦‚ lx_music.xcworkspace -> lx_music
          SCHEME_NAME=$(basename "$WORKSPACE_FILE" .xcworkspace)

          echo "âœ… è‡ªåŠ¨è¯†åˆ«æˆåŠŸï¼"
          echo "   å·¥ä½œç©ºé—´æ–‡ä»¶: $WORKSPACE_FILE"
          echo "   é¡¹ç›®åç§° (Scheme): $SCHEME_NAME"

          # 3. å¼€å§‹ç¼–è¯‘ (æ— ç­¾åæ¨¡å¼)
          xcodebuild -workspace "$WORKSPACE_FILE" \
            -scheme "$SCHEME_NAME" \
            -configuration Release \
            -sdk iphoneos \
            -derivedDataPath build \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO

      - name: Package into IPA
        run: |
          cd ios
          # å†æ¬¡è·å–åå­—ç”¨äºæ‰“åŒ…
          WORKSPACE_FILE=$(find . -maxdepth 1 -name "*.xcworkspace" | head -n 1)
          SCHEME_NAME=$(basename "$WORKSPACE_FILE" .xcworkspace)
          
          mkdir Payload
          # æŸ¥æ‰¾ç”Ÿæˆçš„ .app æ–‡ä»¶ (å› ä¸ºæœ‰æ—¶å€™åå­—å¯èƒ½å¤§å°å†™ä¸ä¸€è‡´ï¼Œæ‰€ä»¥ç”¨ find æ¨¡ç³ŠæŸ¥æ‰¾)
          APP_PATH=$(find build/Build/Products/Release-iphoneos -maxdepth 1 -name "*.app" | head -n 1)
          
          if [ -z "$APP_PATH" ]; then
             echo "âŒ é”™è¯¯: ç¼–è¯‘å¥½åƒæˆåŠŸäº†ï¼Œä½†åœ¨è¾“å‡ºç›®å½•æ‰¾ä¸åˆ° .app æ–‡ä»¶"
             ls -R build/Build/Products/
             exit 1
          fi
          
          echo "ğŸ“¦ æ­£åœ¨æ‰“åŒ…: $APP_PATH"
          mv "$APP_PATH" Payload/
          zip -r trollstore-app.ipa Payload

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: trollstore-ipa
          path: ios/trollstore-app.ipa
