name: Build for TrollStore

on:
  push:
    branches: [ "master", "main" ]
  workflow_dispatch:

jobs:
  build-ad-hoc:
    runs-on: macos-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install JS Dependencies
        run: |
          npm install --legacy-peer-deps

      - name: Install Pods (Clean Install)
        run: |
          cd ios
          # ä¸ºäº†é˜²æ­¢ç‰ˆæœ¬ä¸ä¸€è‡´ï¼Œå…ˆåˆ é™¤é”æ–‡ä»¶ï¼ˆå¯é€‰ï¼Œä½†æ¨èï¼‰
          rm -f Podfile.lock
          # é‡æ–°å®‰è£…åŸç”Ÿä¾èµ–
          pod install --repo-update

      - name: ğŸ” Detect Project & Build (Ad-Hoc Sign)
        run: |
          cd ios
          
          # 1. è‡ªåŠ¨å¯»æ‰¾ .xcworkspace
          WORKSPACE_FILE=$(find . -maxdepth 1 -name "*.xcworkspace" | head -n 1)
          SCHEME_NAME=$(basename "$WORKSPACE_FILE" .xcworkspace)

          if [ -z "$WORKSPACE_FILE" ]; then
            echo "âŒ æ‰¾ä¸åˆ° .xcworkspace æ–‡ä»¶"
            exit 1
          fi

          echo "âœ… æ­£åœ¨ç¼–è¯‘: $SCHEME_NAME (ä½¿ç”¨ Ad-Hoc ä¼ªç­¾å)"

          # 2. å¼€å§‹ç¼–è¯‘
          # å…³é”®ä¿®æ”¹ï¼šCODE_SIGN_IDENTITY="-" è¡¨ç¤ºä½¿ç”¨ Ad-Hoc ç­¾å
          # è¿™æ ·åŸç”Ÿåº“ (å¦‚ react-native-fs) æ‰èƒ½è¢«ç³»ç»Ÿæ­£å¸¸åŠ è½½
          xcodebuild -workspace "$WORKSPACE_FILE" \
            -scheme "$SCHEME_NAME" \
            -configuration Release \
            -sdk iphoneos \
            -derivedDataPath build \
            CODE_SIGN_IDENTITY="-" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=YES

      - name: Package into IPA
        run: |
          cd ios
          WORKSPACE_FILE=$(find . -maxdepth 1 -name "*.xcworkspace" | head -n 1)
          SCHEME_NAME=$(basename "$WORKSPACE_FILE" .xcworkspace)
          
          mkdir Payload
          # æ¨¡ç³ŠæŸ¥æ‰¾ .app æ–‡ä»¶
          APP_PATH=$(find build/Build/Products/Release-iphoneos -maxdepth 1 -name "*.app" | head -n 1)
          
          if [ -z "$APP_PATH" ]; then
             echo "âŒ æ‰¾ä¸åˆ°ç¼–è¯‘å¥½çš„ .app æ–‡ä»¶"
             exit 1
          fi
          
          mv "$APP_PATH" Payload/
          zip -r trollstore-app-fixed.ipa Payload

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: trollstore-ipa-fixed
          path: ios/trollstore-app-fixed.ipa
