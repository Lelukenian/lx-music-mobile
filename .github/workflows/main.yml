name: Build for TrollStore

on:
  push:
    branches: [ "master", "main" ]
  workflow_dispatch:

jobs:
  build-no-sign:
    runs-on: macos-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4  # 这里改成 v4

      - name: Setup Node.js
        uses: actions/setup-node@v4 # 这里改成 v4
        with:
          node-version: 18

      - name: Install JS Dependencies
        run: |
          npm install --legacy-peer-deps 
          # lx-music 可能需要加这个参数防止依赖报错

      - name: Install Pods
        run: |
          cd ios
          pod install --repo-update

      - name: Build Unsigned App
        run: |
          cd ios
          # 我帮你改成了 lx_music_mobile，这是最常见的名字
          # 如果还是报错找不到 workspace，请去 ios 文件夹确认名字
          xcodebuild -workspace lx_music_mobile.xcworkspace \
            -scheme lx_music_mobile \
            -configuration Release \
            -sdk iphoneos \
            -derivedDataPath build \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO

      - name: Package into IPA
        run: |
          cd ios
          mkdir Payload
          # 移动 .app 文件
          mv build/Build/Products/Release-iphoneos/lx_music_mobile.app Payload/
          # 压缩
          zip -r trollstore-app.ipa Payload

      - name: Upload Artifact
        uses: actions/upload-artifact@v4 # 必须改成 v4 才能解决你的报错
        with:
          name: trollstore-ipa
          path: ios/trollstore-app.ipa
