name: Build for TrollStore

on:
  push:
    branches: [ "master", "main" ]
  workflow_dispatch:

jobs:
  build-manual-sign:
    runs-on: macos-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install JS Dependencies
        run: |
          npm install --legacy-peer-deps

      - name: Install Pods
        run: |
          cd ios
          rm -f Podfile.lock
          pod install --repo-update

      - name: ğŸ” Detect Project
        run: |
          cd ios
          # è‡ªåŠ¨è¯†åˆ«é¡¹ç›®å
          WORKSPACE_FILE=$(find . -maxdepth 1 -name "*.xcworkspace" | head -n 1)
          if [ -z "$WORKSPACE_FILE" ]; then
            echo "âŒ æ‰¾ä¸åˆ° .xcworkspace æ–‡ä»¶"
            exit 1
          fi
          SCHEME_NAME=$(basename "$WORKSPACE_FILE" .xcworkspace)
          echo "PROJECT_NAME=$SCHEME_NAME" >> $GITHUB_ENV
          echo "WORKSPACE_PATH=$WORKSPACE_FILE" >> $GITHUB_ENV
          echo "âœ… æ£€æµ‹åˆ°é¡¹ç›®: $SCHEME_NAME"

      - name: ğŸ—ï¸ Build (No Sign)
        run: |
          cd ios
          # å…³é”®ç‚¹1ï¼šè¿™é‡Œä½¿ç”¨ ALLOWED=NOï¼Œä¸ºäº†è®© Xcode é¡ºåˆ©è·‘å®Œç¼–è¯‘ï¼Œä¸æŠ¥æˆªå›¾é‡Œçš„é”™
          xcodebuild -workspace "${{ env.WORKSPACE_PATH }}" \
            -scheme "${{ env.PROJECT_NAME }}" \
            -configuration Release \
            -sdk iphoneos \
            -derivedDataPath build \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO

      - name: âœï¸ Manual Fake Sign & Package
        run: |
          cd ios
          mkdir Payload
          
          # æ‰¾åˆ°ç¼–è¯‘å¥½çš„ .app
          APP_PATH=$(find build/Build/Products/Release-iphoneos -maxdepth 1 -name "*.app" | head -n 1)
          if [ -z "$APP_PATH" ]; then
             echo "âŒ æ‰¾ä¸åˆ° .app æ–‡ä»¶"
             exit 1
          fi
          
          echo "ğŸ“¦ æ‰¾åˆ°åº”ç”¨: $APP_PATH"
          
          # å…³é”®ç‚¹2ï¼šæ‰‹åŠ¨ä¼ªç­¾åï¼
          # è¿™æ­¥æ˜¯ä¸“é—¨è§£å†³ 'not linked' é—ªé€€é—®é¢˜çš„
          # æˆ‘ä»¬åœ¨æ‰“åŒ…å‰ï¼Œç”¨å‘½ä»¤è¡Œå¼ºåˆ¶ç»™å®ƒç­¾ä¸€ä¸ª Ad-Hoc å
          echo "ğŸ” æ­£åœ¨è¿›è¡Œæ‰‹åŠ¨ä¼ªç­¾å..."
          codesign -s - --deep --force --preserve-metadata=identifier,entitlements "$APP_PATH"
          
          # ç§»åŠ¨å¹¶å‹ç¼©
          mv "$APP_PATH" Payload/
          zip -r trollstore-app-signed.ipa Payload

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: trollstore-ipa-final
          path: ios/trollstore-app-signed.ipa
